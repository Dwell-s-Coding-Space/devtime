name: Deploy Preview

on:
  pull_request:
    branches:
      - 'week*'

jobs:
  'deploy-preview':
    name: 'Deploy Preview'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false

      - name: Comment staged deployment URL
        uses: actions/github-script@v7
        with:
          script: |
            const upsert = require('./.github/scripts/upsert-pr-comment.js');

            const baseBranch = context.payload.pull_request.base.ref;
            const appId = `${{ secrets.AMPLIFY_APP_ID }}`;
            const deployUrl = `https://${baseBranch}.${appId}.amplifyapp.com`;

            const title = '### Staged Deployment'

            const body = [
              title,
              '',
              `This PR targets \`${baseBranch}\`. Once merged, changes will be live at:`,
              '',
              `**${deployUrl}**`,
            ].join('\n');


            await upsert({ github, context, marker: title, body });
