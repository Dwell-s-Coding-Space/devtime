name: Deploy Preview

on:
  pull_request:
    branches:
      - 'week*'

jobs:
  'deploy-preview':
    name: 'Deploy Preview'
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Comment staged deployment URL
        uses: actions/github-script@v7
        with:
          script: |
            const baseBranch = context.payload.pull_request.base.ref;
            const appId = `${{ secrets.AMPLIFY_APP_ID }}`;
            const deployUrl = `https://${baseBranch}.${appId}.amplifyapp.com`;

            const body = [
              '### Staged Deployment',
              '',
              `This PR targets \`${baseBranch}\`. Once merged, changes will be live at:`,
              '',
              `**${deployUrl}**`,
            ].join('\n');

            const {data: comments} = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            })

            const existing = comments.find(c => c.body.includes('### Staged Deployment'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              })
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              })
            }
